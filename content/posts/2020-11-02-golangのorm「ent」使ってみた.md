---
template: post
title: GolangのORM「ent」使ってみた
slug: go_ent
socialImage: /media/42-line-bible.jpg
draft: false
date: 2020-11-02T12:14:45.505Z
description: 最近耳にするfacebook製のORMであるentを使用して簡単なAPIサーバーを構築してみた
category: Go
tags:
  - Go
---


## はじめに

Goには様々なORMがあります。メジャーなところでいうと[GORM](https://github.com/go-gorm/gorm)でしょうか。
最近よく聞く「[ent](https://github.com/facebook/ent)」というFacebookが開発したORMを使って軽く遊んでみます。

## ent

entが開発された動機は以下の通りです。

* Goコードとしてのスキーマ
* 型の安全性
  コードジェネレータもあり、これからどんどんリッチになるであろうライブラリです。

## 準備

GoとMySQLの環境はローカルにあるものとします。
entを使うためにはCLIをインストールする必要があります。

```

```

また、空のプロジェクトディレクトリを作成し、Go modulesで初期化します。

```

```

次にスキーマを作成します。今回はとりあえずユーザー情報（名前と年齢）を登録・取得するAPIを作成します。`User`を作成します。

```

```

すると以下のようにファイルが作成され、`ent/schema/user.go`にスキーマコードが生成されます。

```

```

## フィールドの作成

* `ent/schema/user.go`

```

```

このままでは`User`フィールドは空のままなので、`name`と`age`のフィールドを作成します。

```

```

ここまでできたらモデルを生成します。

```

```

すると以下のファイルが生成されます。

```

```

## 実装

### マイグレーション

main.goを作成し、マイグレーション用のコードを書いていきます。このようにしておくことで、`ent/schema/user.go`を修正・追記してもテーブルをよしなにしてくれます。

* main.go

```

```

今回は、コードをGitHubなどで管理することも考慮して、MySQLの設定を.envファイルに記述して読み込むことにします。.envは.gitignoreに追記することを忘れないようにしましょう。

* .env 記述例

```

```

#### マイグレーションの確認

ここまですると、MySQLにカラムが作成されているはずです。
MySQLに入り、

```

```

↑を実行すると、カラムが作成されていることが確認できます。
![https://gyazo.com/388300134dbe60dcc24a7a5242fd230e](https://gyazo.com/388300134dbe60dcc24a7a5242fd230e/raw)

### ハンドラの実装

ユーザー情報を全件取得するGET、id指定で取得するGET、ユーザー情報を登録するPOSTの３種類のハンドラを作成します。
それぞれのハンドラをmain.goのmainに追記していきます。
ウェブアプリケーションは今回はechoを使用します。

```

```

#### 各エンティティの操作

データの選択の場合は`Query()`を使用します。
これは条件の指定がないのでとてもシンプルですね。

```

```

idを指定して1件のみ取得したい場合は、生のSQLと同じように`Where()`句を使うことで条件を指定できます。１件のみの取得の場合は`OnlyX()`を使用します。

```

```

最後にデータの追加です。
`Create()`を使い、登録したいNameとAgeを与えて上げれば登録できます。
リクエストボディから値を受け取れるようにすればもっと良い感じになりそうです。

```

```

## おわりに

今回は簡単なGETリクエストとPOSTリクエストのみを実装しましたが、とてもわかりやすかったです。マイグレーション機能も他のORMより良さげな雰囲気を感じたので、今後採用される機会は増えていくのではないでしょうか。
今回作成したリポジトリを置いておくので、ぜひ参考にしてください。
間違い等ございましたら、twitterかgithubから教えて下さい！

* [SHOOOOUT/ent_api](https://github.com/SHOOOOUT/ent_api)